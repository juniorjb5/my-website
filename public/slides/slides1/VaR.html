<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>VaR - Value at Risk</title>
    <meta charset="utf-8" />
    <meta name="author" content="PhD.(C). Orlando Joaqui-Barandica" />
    <meta name="date" content="2022-01-01" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/rladies.css" rel="stylesheet" />
    <link href="libs/remark-css/rladies-fonts.css" rel="stylesheet" />
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/shareon/shareon.min.css" rel="stylesheet" />
    <script src="libs/shareon/shareon.min.js"></script>
    <link href="libs/xaringanExtra-shareagain/shareagain.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-shareagain/shareagain.js"></script>
    <link href="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <link href="libs/font-awesome/css/all.min.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
    <link href="libs/font-awesome-animation/font-awesome-animation-emi.css" rel="stylesheet" />
    <script src="libs/fontawesome/js/fontawesome-all.min.js"></script>
    <link rel="stylesheet" href="sydney.css" type="text/css" />
    <link rel="stylesheet" href="fonts_mtheme.css" type="text/css" />
    <link rel="stylesheet" href="cols.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">








class: inverse, left, bottom
background-image: url("img/pitana3.jpg")
background-size: cover


# **VaR - Value at Risk**
----

## **Universidad del Valle**

### PhD.(C). Orlando Joaqui-Barandica
### 2022





---
name: hola
class: inverse, middle, center
background-color: #E31D1D

&lt;img style="border-radius: 50%;" src="img/uv3.jpg"
width="150px"
/&gt;

# Universidad del Valle


---





&lt;br&gt;&lt;br&gt;

.center[
&lt;img style="border-radius: 50%;" src="img/avatar.png"
width="160px" href="https://www.joaquibarandica.com"
/&gt;

[PhD.(C) Orlando Joaqui-Barandica](https://www.joaquibarandica.com) &lt;br/&gt;
Universidad del Valle
]

&lt;br&gt;



.center[

*PhD.(C) Ingeniería con enfásis en Ingeniería Industrial* 
 
*MSc. Economía Aplicada*
 
*Estadístico*

&lt;br&gt;

<i class="fas  fa-link fa-spin "></i> [www.joaquibarandica.com](https://www.joaquibarandica.com)

]





---

class: center, middle

&lt;img src="img/gifinc.jpg" width="50%"/&gt;

### [https://gifinc.univalle.edu.co/](https://gifinc.univalle.edu.co/)


---

name: VaR
class: inverse, center, middle
background-color: #00081d

# <i class="fa fa-upload" role="presentation" aria-label="upload icon"></i>
# VaR - Value at Risk

----

.right[
.bottom[
####  [<i class="fa fa-bell" role="presentation" aria-label="bell icon"></i>](#menu)
]
]

---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> VaR


.pull-left[

&lt;br&gt;
&lt;br&gt;

El Valor en Riesgo (VaR) es una de las medidas utilizadas para evaluar el riesgo de una determinada posición o cartera de activos financieros.

&lt;br&gt;

La definición del VaR puede hacerse en términos de **rentabilidades** o en términos de **Pérdidas y Ganancias** (términos nominales).

]


.pull-right[

![](https://media.giphy.com/media/d5FbeKADxF3CSf7y1L/giphy.gif)



]



---


class: center, middle



# El VaR responde entonces a la pregunta:



### ¿Cuál es la caída o pérdida que se podría sufrir en condiciones normales de mercado en un intervalo de tiempo y con cierto nivel de probabilidad o de confianza?




---


class: center, middle

## Es decir, indica la probabilidad (normalmente 1% o 5%) de sufrir una determinada pérdida durante un periodo de tiempo (normalmente 1 día, 1 semana o 1 mes).

--

&lt;br&gt;

## Una interpretación equivalente es:

--

&lt;br&gt;

### Con probabilidad `$$1- \alpha$$` el propietario de dicha posición experimentará una pérdida no superior al VaR.

---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> VaR

.pull-left[

Ejemplo:

&lt;br&gt;

&gt; Una entidad financiera podría considerar que el **VaR** diario de una cartera operativa es de 50 millones de euros, con un nivel de confianza del 90%. 

&lt;br&gt;

----

&lt;br&gt;

&gt; Esto quiere decir que solamente hay 1 posibilidad en 10, en condiciones normales de mercado, de que haya una pérdida superior a los 50 millones de euros.

]


.pull-right[


![](https://media.giphy.com/media/KDtXdzo3vBx5e1HcjU/giphy.gif)


]


---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> VaR


&lt;img src="img/Imagen2.png" width="50%" style="display: block; margin: auto;" /&gt;

.center[

### Por consiguiente, el VaR no es sino un determinado percentil de la distribución de probabilidad prevista para las variaciones en el valor de mercado de la cartera en el horizonte de tiempo escogido.

]

---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Cálculo del VaR


## Tipos de VaR


- **VaR Histórico, No Paramétrico:** se encuentra el `\(\alpha\)` percentil de la distribución histórica de los datos.

&lt;br/&gt;

- **VaR Paramétrico:** se calcula el VaR con base en un modelo que describe su función de densidad de las pérdidas. La cual debe ser estimada.
  - VaR suponiendo que las pérdidas siguen una distribución Gaussiana no condicional.

  - VaR modelando los valores futuros de la media y la varianza condicionales.

  - VaR por simulación de Montecarlo (estimando la función multivariada que describe los datos, por ejemplo mediante cópulas)



---






# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Cálculo del VaR


## Tipos de VaR: Método No Paramétrico - Histórico



.pull-left[

- No precisa hacer supuestos acerca de la forma paramétrica de la distribución de rentabilidades de los factores de riesgo o de la cartera.

- No está limitado a carteras en las que los pagos tienen una estructura lineal.

- El método histórico debe utilizarse solo para el cálculo del VaR a un horizonte de muy pocos días.


]


.pull-right[

`$$VaR_{(1-\alpha)} = q_{(1-\alpha)(R)}  \nonumber$$`

]



---



# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Cálculo del VaR


## Tipos de VaR: Método Paramétrico - Distribución Gaussiana


.pull-left[

- Suponemos que la distribución de las rentabilidades de los factores sigue una distribución Normal multivariante y la cartera es función lineal de los factores.

- Su ventaja es que es tratable analíticamente, pero solo se puede generalizar a una pocas formas paramétricas, como la Normal, la t-Student, o mixturas de Normales o de t-Student.




]


.pull-right[


.center[
Como `\(\alpha\)` es un valor reducido: 5%, 1% o 0.01%, entonces `\(R^*\)` será una rentabilidad negativa, y el VaR se proporciona cambiando el signo.
]


`$$VaR = -R^{\*} \Rightarrow \alpha = P(R&lt;R^{\*}) = \Phi\left( \frac{R^{\*}-\mu_R}{\sigma_R} \right) \nonumber$$`

`$$VaR_{(1-\alpha)} = \Phi^{-1}(1-\alpha) \sigma_R - \mu_R  \nonumber$$`




]

---



# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Cálculo del VaR


## Tipos de VaR: Método de normalidad estático


`$$VaR_{(1-\alpha)} = \Phi^{-1}(1-\alpha) \sigma_R - \mu_R  \nonumber$$`


## Tipos de VaR: Método de normalidad condicional


`$$VaR_{(1-\alpha),t+1} = \Phi^{-1}(1-\alpha) \sigma_{R,t+1} - \mu_{R,t+1}  \nonumber$$`



- Estimación de `\(\mu_{t+1}\)`: Modelos ARIMA de series de tiempo
- Estimación de `\(\sigma_{t+1}\)`: Modelos de varianza condicional:
  - Modelos GARCH: como un ARMA sobre la varianza con algunas restricciones.
  - Modelos de Volatilidad Estocástica: una versión más general de los GARCH.





---


# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Cálculo del VaR


## Tipos de VaR: Método de simulación MonteCarlo - estático


`$$VaR_{(1-\alpha)} = \sigma_R(-q_{(1-\alpha)}(Z))  - \mu_R, \quad \quad Z\sim N(0,1)  \nonumber$$`


## Tipos de VaR: Método de simulación MonteCarlo - dinámico


`$$VaR_{(1-\alpha)} = \sigma_{R,t+1}(-q_{(1-\alpha)}(Z))  - \mu_{R,t+1}, \quad \quad Z\sim N(0,1)  \nonumber$$`

---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Limitaciones


.pull-left[

Como se puede observar existen diversas metodologías, con diferentes niveles de precisión, para estimar el Valor en Riesgo. No obstante, todas estas metodologías presentan limitaciones generales, que caracterizan la técnica del VaR y que por ende son imposibles de evitar sin recurrir a otras herramientas.


----

&gt; - Dice muy poco sobre los casos en las colas (pérdidas extremas).
&gt; - Puede crear estructuras perversas de incentivos (porque no se conoce la magnitud de las pérdidas que exceden las colas).

----

]

.pull-right[

![](https://media.giphy.com/media/giC1lIEz7iOIk5vp3U/giphy.gif)

]


---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Expected Shortfall (CVaR)


.pull-left[

Mientras que el **VaR estima lo máximo que se puede esperar perder** si un evento de pérdidas extremas no ocurre, es decir, la peor pérdida esperada en caso de una relativa regularidad financiera, el **ES (Expected Shortfall) indica cuánto se espera perder si un evento extremo efectivamente ocurre** (más allá del nivel de confianza del VaR, en las colas de la distribución).


----


`$$ES = E[R / ( R &lt; VaR )] \nonumber$$`

----

]

.pull-right[


&lt;img src="img/Imagen3.PNG" width="75%" style="display: block; margin: auto;" /&gt;


]


---

# <i class="fa fa-circle" role="presentation" aria-label="circle icon"></i> Código en R


.scroll-output[


```r
library(quantmod)
library(PerformanceAnalytics)


#########Fecha inicial de descarga de datos
maxDate = "2000-01-01"

#Serie a descargar
tick&lt;-"AMZN"

#Obtener la serie de precios desde Yahoo Finance
prices &lt;- Ad(getSymbols(tick, auto.assign = FALSE, from=maxDate))
plot(prices)
View(prices)


#Calcular retornos
rets &lt;- dailyReturn(prices)
plot(rets)
hist(rets)


library(tseries)
jarque.bera.test(rets)


#Calcular VaR y CVaR
VaR(rets,p=0.95,method = "historical")
quantile(rets,0.05)

VaR(rets,p=0.99,method = "gaussian")
VaR(rets, p = 0.99, method = "historical")
ES(rets,p=0.99,method = "gaussian")
ES(rets, p = 0.99, method = "historical")



#Series que conforman el portafolio
tickers&lt;- c("MSFT", "AAPL", "AMZN")

#Definir pesos del portafolio
weights&lt;-c(0.5,0.1,0.4)

#Obtener series de precios del portafolio
getSymbols(tickers, from=maxDate)
View(AAPL)

#Crear el portafolio
Port.prices &lt;- na.omit(merge(Ad(MSFT),Ad(AAPL), Ad(AMZN)))
colnames(Port.prices)&lt;-tickers
View(Port.prices)
plot(Port.prices)


#Retornos del portafolio
Port.returns &lt;- ROC(Port.prices,type="discrete")[-1]
colnames(Port.returns)&lt;-tickers
View(Port.returns)
plot(Port.returns)

VaR(Port.returns,p=0.95, weights = weights, portfolio_method = "component", method = "historical")
ES(Port.returns,p=0.95, weights = weights, portfolio_method = "component", method = "historical")


#Calcular VaR Individual
VaR.Hist&lt;- VaR(Port.returns,p=0.95, weights = NULL, portfolio_method = "single", method = "historical")
VaR.Gaus&lt;- VaR(Port.returns,p=0.95, weights = NULL, portfolio_method = "single", method = "gaussian")
VaR.Mod&lt;- VaR(Port.returns,p=0.95, weights = NULL, portfolio_method = "single", method = "modified")

#Guardar datos
All.VaR&lt;-data.frame(rbind(VaR.Hist,VaR.Gaus,VaR.Mod))
rownames(All.VaR)&lt;-c("Hist","Gaus","Mod")

All.VaR

#Calcular VaR Portfolio
Port.VaR.Hist&lt;- VaR(Port.returns,p=0.95, weights = weights, portfolio_method = "component", method = "historical")$hVaR
Port.VaR.Gaus&lt;- VaR(Port.returns,p=0.95, weights = weights, portfolio_method = "component", method = "gaussian")$VaR
Port.VaR.Mod&lt;- VaR(Port.returns,p=0.95, weights = weights, portfolio_method = "component", method = "modified")$MVaR


All.VaR$Portafolio&lt;-c(Port.VaR.Hist,Port.VaR.Gaus,Port.VaR.Mod)
All.VaR&lt;-abs(All.VaR)
All.VaR$Type&lt;-c("Hist","Gaus","Mod")

All.VaR

#Base para gráfico
library(reshape2)
library(ggplot2)
plotVaR&lt;-melt(All.VaR,variable.name = "Ticker", value.name = "VaR")


g1&lt;-ggplot(plotVaR,aes(x=Type,y=VaR, fill=Ticker))+
  geom_bar(stat="identity", position = "dodge") 

g1





############################################################################


#Simulación Monte Carlo para el VaR de una acción



#Instalar librerias

library(quantmod)
#library(tidyquant)
library(xts)
#library(rvest)
library(tidyverse)
#library(stringr)
#library(forcats)
#library(lubridate)
#library(plotly)
library(dplyr)
#library(PerformanceAnalytics)


#Simulamos un año bursatil

periodos &lt;- 252
periodos &lt;- periodos - 1

#descargamos los stocks

getSymbols("TSLA", from = '2015-01-01', to = "2022-01-06", warnings = FALSE, auto.assign = TRUE)

TSLA_adj &lt;- TSLA$TSLA.Adjusted

TSLA_log_returns &lt;- dailyReturn(Ad(TSLA), type="log")

# Creamos la función

gbm_sim &lt;- function(periodos, close_prices, vector_returns) {
  # estimadores de mu y sigma
  mu &lt;- mean(vector_returns)
  sig &lt;- sd(vector_returns)
  fin &lt;- length(vector_returns)
  ini &lt;- fin - periodos
  
  # simulacion
  sim_actual_values &lt;- TSLA$TSLA.Close[ini]
  S &lt;-  vector(mode="numeric", length=periodos) # aqui vamos guardando los valores
  S[1] &lt;- sim_actual_values
  for (t in c(2:periodos) ) {
    new_S &lt;- S[t-1] * exp( (mu-(0.5*sig^2)) + sig * rnorm(1)   )
    S[t] &lt;- new_S
  } 
  return(S)
}

#Ahora simulamos 1000 realidades distintas

# AHora podemos simular varias veces y plotear:
n_sims = 1000
n_periods = 252
sims &lt;- matrix(NA, ncol=n_sims+1, nrow=n_periods)

for (i in 1:n_sims) {
  values &lt;-  gbm_sim(periodos = 252, close_prices =  TSLA$TSLA.Adjusted, vector_returns = TSLA_log_returns)
  sims[, i] &lt;- values
}
sims[, n_sims+1] &lt;- 1:n_periods

# Seteo del plot
plot(sims[, n_sims+1], sims[,1], type="l",
     xlab="tiempo", ylab="W(t)", ylim=c(0, 2000))
colors = rainbow(n_sims)

# add lines
for ( i in 1:n_sims) {
  lines(sims[, n_sims+1], sims[,i], type="l", col=colors[i])
}


# VALUE AT RISK 
# En sims, tenemos los PRECIOS simulados. Necesitamos las rentabilidades.
# Tenemos que convertir, cada columna de sims, en Rentabilidades.

returns_gbm &lt;- apply( sims[,c(1:n_sims)], 2, Delt)


# Histograma de todas esas rentabilidades
hist(returns_gbm, 40)

# Porcentil 5 -- VAR al  99% y 95%
quantile(returns_gbm, c(0.05, 0.01), na.rm=TRUE) 



# Histograma de todas esas rentabilidades
hist(returns_gbm, 40)
abline(v=quantile(returns_gbm, c(0.05), na.rm=TRUE) )
```

]

---



class: inverse, center, middle
background-color: #00081d




.pull-left[

.center[
&lt;br&gt;&lt;br&gt;

# Gracias!!!

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;



### Preguntas?
]


]


.pull-right[


.center[

&lt;br&gt;&lt;br&gt;&lt;br&gt;


.center[
&lt;img style="border-radius: 50%;" src="img/avatar.png"
width="100px" href="https://www.joaquibarandica.com"
/&gt;

<span>&lt;i class="fas  fa-envelope faa-passing animated "&gt;&lt;/i&gt;</span> orlando.joaqui@correounivalle.edu.co 
]


&lt;img src="img/qr-code.png" width="50%" style="display: block; margin: auto;" /&gt;


.center[
www.joaquibarandica.com
]



]


]


&lt;br&gt;&lt;br&gt;&lt;br&gt;
----




    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="cols_macro.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
